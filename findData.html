<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 검색 및 스크립트 추출 프로젝트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .input-group { margin-bottom: 10px; }
        #results { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        #status { margin-top: 10px; color: green; }
        #error { margin-top: 10px; color: red; }
    </style>
</head>
<body>
    <h1>YouTube 키워드 검색 및 스크립트 추출</h1>
    
    <!-- 키워드 입력 박스 5개 -->
    <div class="input-group">
        <label for="keyword1">키워드 1:</label>
        <input type="text" id="keyword1" placeholder="키워드 입력" value="실화">
    </div>
    <div class="input-group">
        <label for="keyword2">키워드 2:</label>
        <input type="text" id="keyword2" placeholder="키워드 입력" value="경험담">
    </div>
    <div class="input-group">
        <label for="keyword3">키워드 3:</label>
        <input type="text" id="keyword3" placeholder="키워드 입력" value="썰">
    </div>
    <div class="input-group">
        <label for="keyword4">키워드 4:</label>
        <input type="text" id="keyword4" placeholder="키워드 입력" value="사연">
    </div>
    <div class="input-group">
        <label for="keyword5">키워드 5:</label>
        <input type="text" id="keyword5" placeholder="키워드 입력" value="정보">
    </div>
    
    <!-- API 키 입력 (보안을 위해 사용자 입력으로 함) -->
    <div class="input-group">
        <label for="apiKey">YouTube API 키:</label>
        <input type="text" id="apiKey" placeholder="API 키 입력 (필수)" value="AIzaSyAG6k-fmqTV_aHQbaTn920RANy_5C-92gY">
        <p style="font-size: 12px;">API 키는 <a href="https://developers.google.com/youtube/v3/getting-started" target="_blank">Google Developers Console</a>에서 발급받으세요. 프로젝트 생성 후 YouTube Data API v3 활성화 필요.</p>
    </div>
    
    <!-- 찾기 버튼 -->
    <button id="searchButton">찾기</button>
    
    <!-- 결과 목록 표시 영역 -->
    <div id="results">
        <h2>검색 결과</h2>
        <table id="resultTable">
            <thead>
                <tr>
                    <th>키워드</th>
                    <th>채널명</th>
                    <th>조회수</th>
                    <th>영상 주소</th>
                    <th>채널 ID</th>
                    <th>비디오 ID</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <!-- 내용 가져오기 버튼 -->
    <button id="fetchScriptsButton" style="display: none; margin-top: 20px;">내용 가져오기 (스크립트 추출 및 DB 저장)</button>
    
    <!-- 상태 메시지 -->
    <div id="status"></div>
    <div id="error"></div>

    <script>
        // IndexedDB 설정 (웹 DB로 사용)
        let db;
        const dbName = "YouTubeScriptsDB";
        const dbVersion = 1;
        const storeName = "scripts";

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                request.onerror = (event) => reject("DB 열기 실패: " + event.target.errorCode);
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve();
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        const objectStore = db.createObjectStore(storeName, { keyPath: "videoId" });
                        objectStore.createIndex("keyword", "keyword", { unique: false });
                    }
                };
            });
        }

        // DB에 데이터 저장
        function saveToDB(data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], "readwrite");
                const objectStore = transaction.objectStore(storeName);
                const request = objectStore.add(data);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject("DB 저장 실패: " + event.target.errorCode);
            });
        }

        // 에러 표시 함수
        function showError(message) {
            document.getElementById('error').textContent = message;
        }

        // 상태 표시 함수
        function showStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // 찾기 버튼 이벤트
        document.getElementById('searchButton').addEventListener('click', async () => {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showError('API 키를 입력하세요.');
                return;
            }

            const keywords = [];
            for (let i = 1; i <= 5; i++) {
                const kw = document.getElementById(`keyword${i}`).value.trim();
                if (kw) keywords.push(kw);
            }

            if (keywords.length === 0) {
                showError('최소 하나의 키워드를 입력하세요.');
                return;
            }

            showStatus('검색 중...');
            document.getElementById('fetchScriptsButton').style.display = 'none';
            const tableBody = document.querySelector('#resultTable tbody');
            tableBody.innerHTML = ''; // 기존 결과 초기화

            try {
                await initDB(); // DB 초기화

                for (const keyword of keywords) {
                    // YouTube Search API 호출 (인기 급상승: order=viewCount 사용, 최근 게시: order=date 조합 가능)
                    // 인기 급등을 위해 order=viewCount 사용 (조회수 높은 순), maxResults=10으로 제한
                    const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(keyword)}&type=video&order=viewCount&maxResults=10&key=${apiKey}`;
                    const searchResponse = await fetch(searchUrl);
                    if (!searchResponse.ok) throw new Error(`Search API 오류: ${searchResponse.status}`);

                    const searchData = await searchResponse.json();
                    const videoIds = searchData.items.map(item => item.id.videoId).join(',');

                    if (videoIds) {
                        // Videos API 호출로 조회수 가져오기
                        const videosUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics,snippet&id=${videoIds}&key=${apiKey}`;
                        const videosResponse = await fetch(videosUrl);
                        if (!videosResponse.ok) throw new Error(`Videos API 오류: ${videosResponse.status}`);

                        const videosData = await videosResponse.json();
                        videosData.items.forEach(video => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${keyword}</td>
                                <td>${video.snippet.channelTitle}</td>
                                <td>${video.statistics.viewCount}</td>
                                <td><a href="https://www.youtube.com/watch?v=${video.id}" target="_blank">https://www.youtube.com/watch?v=${video.id}</a></td>
                                <td>${video.snippet.channelId}</td>
                                <td>${video.id}</td>
                            `;
                            tableBody.appendChild(row);

                            // 데이터 속성으로 비디오 ID 저장 (나중에 루프 위해)
                            row.dataset.videoId = video.id;
                            row.dataset.keyword = keyword;
                        });
                    }
                }

                showStatus('검색 완료. 결과가 표시되었습니다.');
                document.getElementById('fetchScriptsButton').style.display = 'block';
            } catch (error) {
                showError(error.message);
            }
        });

        // 내용 가져오기 버튼 이벤트
        document.getElementById('fetchScriptsButton').addEventListener('click', async () => {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showError('API 키를 입력하세요.');
                return;
            }

            const rows = document.querySelectorAll('#resultTable tbody tr');
            if (rows.length === 0) {
                showError('검색 결과가 없습니다.');
                return;
            }

            showStatus('스크립트 추출 중...');

            try {
                for (const row of rows) {
                    const videoId = row.dataset.videoId;
                    const keyword = row.dataset.keyword;

                    // Captions API 호출로 캡션 목록 가져오기 (Google Notebook API 대신 YouTube Captions API 사용, 'script'는 자막/트랜스크립트를 의미한다고 가정)
                    // 참고: 캡션이 공개되어 있어야 함. 자동 생성 캡션도 가능하나, 모든 비디오에 있지 않음.
                    const captionsUrl = `https://www.googleapis.com/youtube/v3/captions?part=snippet&videoId=${videoId}&key=${apiKey}`;
                    const captionsResponse = await fetch(captionsUrl);
                    if (!captionsResponse.ok) {
                        console.warn(`캡션 API 오류 (비디오 ID: ${videoId}): ${captionsResponse.status}`);
                        continue; // 오류 시 스킵
                    }

                    const captionsData = await captionsResponse.json();
                    if (captionsData.items.length === 0) {
                        console.warn(`캡션 없음 (비디오 ID: ${videoId})`);
                        continue;
                    }

                    // 첫 번째 캡션 ID 선택 (보통 en 또는 기본 언어)
                    const captionId = captionsData.items[0].id;

                    // 캡션 다운로드 (ttml 형식으로, 텍스트 추출 필요)
                    const downloadUrl = `https://www.googleapis.com/youtube/v3/captions/${captionId}?tfmt=ttml&key=${apiKey}`;
                    const downloadResponse = await fetch(downloadUrl);
                    if (!downloadResponse.ok) throw new Error(`캡션 다운로드 오류: ${downloadResponse.status}`);

                    const scriptXml = await downloadResponse.text();
                    // XML 파싱하여 텍스트 추출 (간단히 <p> 태그 내 텍스트 모음)
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(scriptXml, "text/xml");
                    const paragraphs = xmlDoc.getElementsByTagName('p');
                    let scriptText = '';
                    for (let p of paragraphs) {
                        scriptText += p.textContent + '\n';
                    }

                    if (scriptText) {
                        // DB에 저장 (videoId를 키로, script와 keyword 저장)
                        await saveToDB({ videoId, keyword, script: scriptText });
                        showStatus(`스크립트 저장 완료 (비디오 ID: ${videoId})`);
                    } else {
                        showStatus(`스크립트 추출 실패 (비디오 ID: ${videoId})`);
                    }
                }

                showStatus('모든 스크립트 처리 완료. IndexedDB에 저장되었습니다.');
            } catch (error) {
                showError(error.message);
            }
        });
    </script>
</body>
</html>
